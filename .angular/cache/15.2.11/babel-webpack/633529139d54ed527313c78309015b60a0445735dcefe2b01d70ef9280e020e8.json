{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/braya/Downloads/ChronosActualizado_modificado/ProyectoAppRegis/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n    r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n    d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nimport { Component } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { FormControl, Validators, FormBuilder } from '@angular/forms';\nimport { Preferences } from '@capacitor/preferences';\nimport { AlertController } from '@ionic/angular';\nimport { ApiService } from '../servicios/api.service';\nimport { finalize, take } from 'rxjs/operators';\nimport { HttpErrorResponse } from '@angular/common/http';\nlet LoginPage = class LoginPage {\n  constructor(fb, router, alertController, apiService) {\n    this.fb = fb;\n    this.router = router;\n    this.alertController = alertController;\n    this.apiService = apiService;\n    this.loading = false;\n    this.loginError = false;\n    this.formLogin = this.fb.group({\n      correo: new FormControl('', [Validators.required, Validators.email]),\n      password: new FormControl('', [Validators.required, Validators.minLength(4)])\n    });\n  }\n  ngOnInit() {}\n  ingresar() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      _this.loginError = false;\n      if (_this.formLogin.invalid) {\n        _this.formLogin.markAllAsTouched();\n        const alert = yield _this.alertController.create({\n          header: 'Error',\n          message: 'Por favor completa todos los campos correctamente.',\n          buttons: ['Aceptar']\n        });\n        yield alert.present();\n        return;\n      }\n      const correoForm = _this.formLogin.value.correo.trim();\n      const contrase√±a = _this.formLogin.value.password.trim();\n      console.log('üîê Intentando login con:', {\n        CorreoElectronico: correoForm,\n        Contrasena: '***' + contrase√±a.substring(Math.max(0, contrase√±a.length - 2))\n      });\n      _this.loading = true;\n      // Enviar con PascalCase como espera el backend .NET\n      _this.apiService.iniciarSesion({\n        CorreoElectronico: correoForm,\n        Contrasena: contrase√±a\n      }).pipe(take(1), finalize(() => _this.loading = false)).subscribe({\n        next: function () {\n          var _ref = _asyncToGenerator(function* (res) {\n            console.log('‚úÖ Login exitoso, respuesta:', res);\n            // Determina correo efectivo (API o form) y rol PRIMERO\n            const correo = (res.correoElectronico ?? correoForm).toLowerCase().trim();\n            const isProfesor = correo.endsWith('@profesor.duocuc.cl');\n            const isAdmin = (res?.nombreUsuario ?? '').toLowerCase().includes('admin');\n            console.log('üìß Correo:', correo, '| Profesor:', isProfesor, '| Admin:', isAdmin);\n            // Guarda datos base\n            yield Preferences.set({\n              key: 'alumnoId',\n              value: String(res.id)\n            });\n            yield Preferences.set({\n              key: 'nombreUsuario',\n              value: res?.nombreUsuario ?? ''\n            });\n            // Guardar objeto usuario para compatibilidad con AutenticacionService\n            yield Preferences.set({\n              key: 'usuario',\n              value: JSON.stringify({\n                id: res.id,\n                nombreUsuario: res?.nombreUsuario ?? '',\n                correoElectronico: correo\n              })\n            });\n            // Persiste rol y profesorId si aplica\n            yield Preferences.set({\n              key: 'rol',\n              value: isProfesor ? 'profesor' : 'alumno'\n            });\n            if (isProfesor && typeof res.profesorId === 'number') {\n              yield Preferences.set({\n                key: 'profesorId',\n                value: String(res.profesorId)\n              });\n            } else {\n              // Limpia profesorId si no corresponde\n              yield Preferences.remove({\n                key: 'profesorId'\n              });\n            }\n            console.log('üíæ Preferences guardadas. Navegando...');\n            // Routing seg√∫n rol con replaceUrl para evitar volver al login\n            if (isAdmin) {\n              yield _this.router.navigate(['/admin'], {\n                replaceUrl: true\n              });\n            } else if (isProfesor) {\n              yield _this.router.navigate(['/teacher-home'], {\n                replaceUrl: true\n              });\n            } else {\n              yield _this.router.navigate(['/home'], {\n                replaceUrl: true\n              });\n            }\n            console.log('üöÄ Navegaci√≥n completada');\n          });\n          return function next(_x) {\n            return _ref.apply(this, arguments);\n          };\n        }(),\n        error: function () {\n          var _ref2 = _asyncToGenerator(function* (err) {\n            _this.loginError = true;\n            console.error('‚ùå Error en login:', err);\n            let message = 'Correo o contrase√±a incorrectos.';\n            if (err instanceof HttpErrorResponse) {\n              console.error('üìõ Status HTTP:', err.status, '| Body:', err.error);\n              if (err.status === 0) message = 'No hay conexi√≥n con el servidor.';else if (err.status >= 500) message = 'Error interno del servidor.';else if (err.status === 401) message = 'Credenciales inv√°lidas. Verifica tu correo y contrase√±a.';else if (typeof err.error === 'string') message = err.error;\n            }\n            const alert = yield _this.alertController.create({\n              header: 'Error',\n              message,\n              buttons: ['Aceptar']\n            });\n            yield alert.present();\n          });\n          return function error(_x2) {\n            return _ref2.apply(this, arguments);\n          };\n        }()\n      });\n    })();\n  }\n  redirectToSignup() {\n    this.router.navigate(['/signup']);\n  }\n};\nLoginPage = __decorate([Component({\n  selector: 'app-login',\n  templateUrl: './login.page.html',\n  styleUrls: ['./login.page.scss']\n}), __metadata(\"design:paramtypes\", [FormBuilder, Router, AlertController, ApiService])], LoginPage);\nexport { LoginPage };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}