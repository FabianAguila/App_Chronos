{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/fabia/Documents/ChronosModificado/ProyectoAppRegis/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { Preferences } from '@capacitor/preferences';\nimport { ApiService } from '../servicios/api.service';\nimport { ToastController, AlertController } from '@ionic/angular';\nimport { take } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"../servicios/api.service\";\nimport * as i3 from \"@ionic/angular\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\nfunction ChatRoomPage_ion_buttons_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-buttons\", 16)(1, \"ion-button\", 17);\n    i0.ɵɵlistener(\"click\", function ChatRoomPage_ion_buttons_9_Template_ion_button_click_1_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.presentAgregarNota());\n    });\n    i0.ɵɵelement(2, \"ion-icon\", 18);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"ion-button\", 19);\n    i0.ɵɵlistener(\"click\", function ChatRoomPage_ion_buttons_9_Template_ion_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r4 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r4.presentMarcarAsistencia());\n    });\n    i0.ɵɵelement(4, \"ion-icon\", 20);\n    i0.ɵɵelementEnd()();\n  }\n}\nconst _c0 = function (a1) {\n  return [\"burbuja\", a1];\n};\nfunction ChatRoomPage_div_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 21)(1, \"div\", 22);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"div\", 23);\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const m_r5 = ctx.$implicit;\n    i0.ɵɵproperty(\"ngClass\", i0.ɵɵpureFunction1(3, _c0, m_r5.de));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(m_r5.texto);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(m_r5.hora);\n  }\n}\nexport let ChatRoomPage = /*#__PURE__*/(() => {\n  class ChatRoomPage {\n    constructor(route, router, api, toastCtrl, alertCtrl) {\n      this.route = route;\n      this.router = router;\n      this.api = api;\n      this.toastCtrl = toastCtrl;\n      this.alertCtrl = alertCtrl;\n      this.conversationPartnerName = '';\n      this.profesorId = null;\n      this.alumnoId = null;\n      this.mensajes = [];\n      this.mensajeNuevo = '';\n      this.privadoRemitente = 'alumno';\n      this.isProfesor = false;\n    }\n    ngOnInit() {\n      var _this = this;\n      const paramId = Number(this.route.snapshot.paramMap.get('id'));\n      // Obtener rol e ids guardados para decidir cómo interpretar el param\n      Preferences.get({\n        key: 'rol'\n      }).then( /*#__PURE__*/function () {\n        var _ref = _asyncToGenerator(function* ({\n          value\n        }) {\n          const rol = value;\n          // nombres de ejemplo (temporal)\n          const nombresProfesores = {\n            1: 'Profesor García',\n            2: 'Profesora Rodríguez',\n            3: 'Profesor Martínez',\n            4: 'Orientadora Pérez'\n          };\n          const nombresAlumnos = {\n            101: 'Alumno Juan Pérez',\n            102: 'Alumno María López',\n            103: 'Alumno Ana Gómez'\n          };\n          if (rol === 'profesor') {\n            _this.isProfesor = true;\n            // como profesor, el param es alumnoId\n            _this.alumnoId = paramId;\n            const {\n              value: pid\n            } = yield Preferences.get({\n              key: 'profesorId'\n            });\n            _this.profesorId = pid ? Number(pid) : null;\n            _this.conversationPartnerId = _this.alumnoId;\n            _this.conversationPartnerName = nombresAlumnos[_this.conversationPartnerId] || 'Alumno';\n            _this.privadoRemitente = 'profesor';\n          } else {\n            _this.isProfesor = false;\n            // como alumno, el param es profesorId\n            _this.profesorId = paramId;\n            const {\n              value: aid\n            } = yield Preferences.get({\n              key: 'alumnoId'\n            });\n            _this.alumnoId = aid ? Number(aid) : null;\n            _this.conversationPartnerId = _this.profesorId;\n            _this.conversationPartnerName = nombresProfesores[_this.conversationPartnerId] || 'Profesor';\n            _this.privadoRemitente = 'alumno';\n          }\n          // Debug: mostrar rol e ids en consola\n          console.log('ChatRoom init — rol:', rol, 'paramId:', paramId, 'profesorId:', _this.profesorId, 'alumnoId:', _this.alumnoId);\n          // Mensajes de ejemplo iniciales: si el usuario es profesor, mostrar los mensajes del profesor primero\n          if (rol === 'profesor') {\n            _this.mensajes = [{\n              de: 'profesor',\n              texto: `Hola, soy el profesor. Voy a responder tus dudas.`,\n              hora: '10:00'\n            }, {\n              de: 'alumno',\n              texto: `Hola profe, soy ${_this.conversationPartnerName} y tengo una duda.`,\n              hora: '10:01'\n            }];\n          } else {\n            _this.mensajes = [{\n              de: 'profesor',\n              texto: `Hola, soy ${_this.conversationPartnerName}. ¿En qué puedo ayudarte?`,\n              hora: '10:00'\n            }, {\n              de: 'alumno',\n              texto: 'Profe, tengo una duda sobre la guía.',\n              hora: '10:01'\n            }];\n          }\n          // Si tenemos ambos ids, cargar la conversación real desde el backend\n          if (_this.profesorId && _this.alumnoId) {\n            _this.api.getConversacion(_this.profesorId, _this.alumnoId).pipe(take(1)).subscribe({\n              next: msgs => {\n                // Esperamos que msgs venga como array de { remitente: 'profesor'|'alumno', texto, fecha }\n                _this.mensajes = msgs.map(m => ({\n                  de: m.remitente,\n                  texto: m.texto,\n                  hora: m.fecha || m.hora || ''\n                }));\n              },\n              error: function () {\n                var _ref2 = _asyncToGenerator(function* (err) {\n                  console.error('Error cargando conversacion', err);\n                  const t = yield _this.toastCtrl.create({\n                    message: 'No se pudo cargar la conversación.',\n                    duration: 2000\n                  });\n                  yield t.present();\n                });\n                return function error(_x2) {\n                  return _ref2.apply(this, arguments);\n                };\n              }()\n            });\n          }\n        });\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    }\n    enviar() {\n      var _this2 = this;\n      const texto = this.mensajeNuevo.trim();\n      if (!texto) {\n        return;\n      }\n      const ahora = new Date();\n      const hora = ahora.toLocaleTimeString([], {\n        hour: '2-digit',\n        minute: '2-digit'\n      });\n      // Preparar payload para enviar al backend\n      const payload = {\n        profesorId: this.profesorId,\n        alumnoId: this.alumnoId,\n        remitente: this.privadoRemitente,\n        texto\n      };\n      // Limpia input inmediatamente\n      this.mensajeNuevo = '';\n      // Mostrar mensaje provisional en UI para feedback (optimista)\n      this.mensajes.push({\n        de: this.privadoRemitente,\n        texto,\n        hora\n      });\n      // Enviar al backend\n      this.api.enviarMensaje(payload).pipe(take(1)).subscribe({\n        next: saved => {\n          // Si backend devuelve el mensaje guardado con fecha/id, podríamos reemplazar o actualizar.\n          // Por simplicidad, si viene texto y fecha, actualizamos la última burbuja.\n          if (saved && (saved.texto || saved.fecha)) {\n            const lastIdx = this.mensajes.length - 1;\n            this.mensajes[lastIdx] = {\n              de: saved.remitente ?? this.privadoRemitente,\n              texto: saved.texto ?? texto,\n              hora: saved.fecha ?? hora\n            };\n          }\n        },\n        error: function () {\n          var _ref3 = _asyncToGenerator(function* (err) {\n            console.error('Error enviando mensaje', err);\n            const toast = yield _this2.toastCtrl.create({\n              message: 'No se pudo enviar el mensaje.',\n              duration: 2000\n            });\n            yield toast.present();\n          });\n          return function error(_x3) {\n            return _ref3.apply(this, arguments);\n          };\n        }()\n      });\n    }\n    // Navega hacia la página correcta según el rol (profesor -> teacher-chat, alumno -> chat)\n    volver() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          value: rol\n        } = yield Preferences.get({\n          key: 'rol'\n        });\n        if (rol === 'profesor') {\n          _this3.router.navigateByUrl('/teacher-chat');\n        } else {\n          _this3.router.navigateByUrl('/chat');\n        }\n      })();\n    }\n    // Mostrar prompt para agregar nota (solo profesor)\n    presentAgregarNota() {\n      var _this4 = this;\n      return _asyncToGenerator(function* () {\n        const alert = yield _this4.alertCtrl.create({\n          header: 'Agregar nota',\n          inputs: [{\n            name: 'valor',\n            type: 'number',\n            attributes: {\n              step: '0.1',\n              min: '1',\n              max: '7'\n            },\n            placeholder: 'Valor (1.0 - 7.0)'\n          }, {\n            name: 'descripcion',\n            type: 'text',\n            placeholder: 'Descripción (opcional)'\n          }],\n          buttons: [{\n            text: 'Cancelar',\n            role: 'cancel'\n          }, {\n            text: 'Agregar',\n            handler: function () {\n              var _ref4 = _asyncToGenerator(function* (data) {\n                const v = parseFloat(data.valor);\n                if (isNaN(v) || v < 1 || v > 7) {\n                  const t = yield _this4.toastCtrl.create({\n                    message: 'Ingrese una nota válida entre 1.0 y 7.0',\n                    duration: 2000\n                  });\n                  yield t.present();\n                  return false; // evita cerrar si querés que el usuario corrija\n                }\n\n                const payload = {\n                  profesorId: _this4.profesorId,\n                  alumnoId: _this4.alumnoId,\n                  valor: v,\n                  descripcion: data.descripcion || '',\n                  fecha: new Date().toISOString()\n                };\n                _this4.api.agregarNotaAlumno(payload).pipe(take(1)).subscribe({\n                  next: function () {\n                    var _ref5 = _asyncToGenerator(function* (res) {\n                      const t = yield _this4.toastCtrl.create({\n                        message: 'Nota agregada',\n                        duration: 1500\n                      });\n                      yield t.present();\n                    });\n                    return function next(_x5) {\n                      return _ref5.apply(this, arguments);\n                    };\n                  }(),\n                  error: function () {\n                    var _ref6 = _asyncToGenerator(function* (err) {\n                      console.error('Error agregando nota', err);\n                      const t = yield _this4.toastCtrl.create({\n                        message: 'No se pudo agregar la nota',\n                        duration: 2000\n                      });\n                      yield t.present();\n                    });\n                    return function error(_x6) {\n                      return _ref6.apply(this, arguments);\n                    };\n                  }()\n                });\n              });\n              return function handler(_x4) {\n                return _ref4.apply(this, arguments);\n              };\n            }()\n          }]\n        });\n        yield alert.present();\n      })();\n    }\n    // Mostrar prompt para marcar asistencia (solo profesor)\n    presentMarcarAsistencia() {\n      var _this5 = this;\n      return _asyncToGenerator(function* () {\n        const alert = yield _this5.alertCtrl.create({\n          header: 'Marcar asistencia',\n          inputs: [{\n            name: 'presente',\n            type: 'radio',\n            label: 'Presente',\n            value: 'true',\n            checked: true\n          }, {\n            name: 'presente',\n            type: 'radio',\n            label: 'Ausente',\n            value: 'false'\n          }],\n          buttons: [{\n            text: 'Cancelar',\n            role: 'cancel'\n          }, {\n            text: 'Registrar',\n            handler: function () {\n              var _ref7 = _asyncToGenerator(function* (value) {\n                const presente = value === 'true';\n                const payload = {\n                  profesorId: _this5.profesorId,\n                  alumnoId: _this5.alumnoId,\n                  fecha: new Date().toISOString(),\n                  presente\n                };\n                _this5.api.marcarAsistenciaAlumno(payload).pipe(take(1)).subscribe({\n                  next: function () {\n                    var _ref8 = _asyncToGenerator(function* () {\n                      const t = yield _this5.toastCtrl.create({\n                        message: 'Asistencia registrada',\n                        duration: 1500\n                      });\n                      yield t.present();\n                    });\n                    return function next() {\n                      return _ref8.apply(this, arguments);\n                    };\n                  }(),\n                  error: function () {\n                    var _ref9 = _asyncToGenerator(function* (err) {\n                      console.error('Error registrando asistencia', err);\n                      const t = yield _this5.toastCtrl.create({\n                        message: 'No se pudo registrar asistencia',\n                        duration: 2000\n                      });\n                      yield t.present();\n                    });\n                    return function error(_x8) {\n                      return _ref9.apply(this, arguments);\n                    };\n                  }()\n                });\n              });\n              return function handler(_x7) {\n                return _ref7.apply(this, arguments);\n              };\n            }()\n          }]\n        });\n        yield alert.present();\n      })();\n    }\n  }\n  ChatRoomPage.ɵfac = function ChatRoomPage_Factory(t) {\n    return new (t || ChatRoomPage)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i1.Router), i0.ɵɵdirectiveInject(i2.ApiService), i0.ɵɵdirectiveInject(i3.ToastController), i0.ɵɵdirectiveInject(i3.AlertController));\n  };\n  ChatRoomPage.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: ChatRoomPage,\n    selectors: [[\"app-chat-room\"]],\n    decls: 19,\n    vars: 4,\n    consts: [[1, \"chat-header\", \"ion-no-border\"], [1, \"header-toolbar\"], [\"slot\", \"start\"], [\"fill\", \"clear\", \"aria-label\", \"Volver\", 3, \"click\"], [\"slot\", \"icon-only\", \"name\", \"chevron-back-outline\"], [1, \"brand\"], [\"name\", \"person-circle-outline\"], [\"slot\", \"end\", 4, \"ngIf\"], [1, \"chat-room-content\"], [1, \"mensajes\"], [3, \"ngClass\", 4, \"ngFor\", \"ngForOf\"], [1, \"chat-input-footer\"], [\"lines\", \"none\"], [\"placeholder\", \"Escribe un mensaje\", 3, \"ngModel\", \"ngModelChange\", \"keyup.enter\"], [\"fill\", \"clear\", 3, \"click\"], [\"name\", \"send-outline\"], [\"slot\", \"end\"], [\"fill\", \"clear\", \"title\", \"Agregar nota\", 3, \"click\"], [\"name\", \"star-outline\"], [\"fill\", \"clear\", \"title\", \"Marcar asistencia\", 3, \"click\"], [\"name\", \"checkmark-done-outline\"], [3, \"ngClass\"], [1, \"texto\"], [1, \"hora\"]],\n    template: function ChatRoomPage_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"ion-header\", 0)(1, \"ion-toolbar\", 1)(2, \"ion-buttons\", 2)(3, \"ion-button\", 3);\n        i0.ɵɵlistener(\"click\", function ChatRoomPage_Template_ion_button_click_3_listener() {\n          return ctx.volver();\n        });\n        i0.ɵɵelement(4, \"ion-icon\", 4);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(5, \"ion-title\", 5);\n        i0.ɵɵelement(6, \"ion-icon\", 6);\n        i0.ɵɵelementStart(7, \"span\");\n        i0.ɵɵtext(8);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵtemplate(9, ChatRoomPage_ion_buttons_9_Template, 5, 0, \"ion-buttons\", 7);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(10, \"ion-content\", 8)(11, \"div\", 9);\n        i0.ɵɵtemplate(12, ChatRoomPage_div_12_Template, 5, 5, \"div\", 10);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(13, \"ion-footer\", 11)(14, \"ion-toolbar\")(15, \"ion-item\", 12)(16, \"ion-input\", 13);\n        i0.ɵɵlistener(\"ngModelChange\", function ChatRoomPage_Template_ion_input_ngModelChange_16_listener($event) {\n          return ctx.mensajeNuevo = $event;\n        })(\"keyup.enter\", function ChatRoomPage_Template_ion_input_keyup_enter_16_listener() {\n          return ctx.enviar();\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(17, \"ion-button\", 14);\n        i0.ɵɵlistener(\"click\", function ChatRoomPage_Template_ion_button_click_17_listener() {\n          return ctx.enviar();\n        });\n        i0.ɵɵelement(18, \"ion-icon\", 15);\n        i0.ɵɵelementEnd()()()();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(8);\n        i0.ɵɵtextInterpolate(ctx.conversationPartnerName);\n        i0.ɵɵadvance(1);\n        i0.ɵɵproperty(\"ngIf\", ctx.isProfesor);\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"ngForOf\", ctx.mensajes);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.mensajeNuevo);\n      }\n    },\n    dependencies: [i4.NgClass, i4.NgForOf, i4.NgIf, i5.NgControlStatus, i5.NgModel, i3.IonButton, i3.IonButtons, i3.IonContent, i3.IonFooter, i3.IonHeader, i3.IonIcon, i3.IonInput, i3.IonItem, i3.IonTitle, i3.IonToolbar, i3.TextValueAccessor],\n    styles: [\".chat-room-content[_ngcontent-%COMP%]{--background: #f3f5f9}.mensajes[_ngcontent-%COMP%]{padding:16px;display:flex;flex-direction:column;gap:12px}.burbuja[_ngcontent-%COMP%]{max-width:76%;padding:10px 14px;border-radius:16px;font-size:15px;line-height:1.3;box-shadow:0 6px 14px #0f172a0f}.burbuja.profesor[_ngcontent-%COMP%]{align-self:flex-start;background:#ffffff;color:#111827;border-top-left-radius:6px}.burbuja.alumno[_ngcontent-%COMP%]{align-self:flex-end;background:linear-gradient(90deg,#2563eb 0%,#06b6d4 100%);color:#fff;border-top-right-radius:6px}.burbuja[_ngcontent-%COMP%]   .hora[_ngcontent-%COMP%]{display:block;font-size:11px;opacity:.75;margin-top:6px;text-align:right}.chat-input-footer[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]{--background: #fff;padding:8px 12px;box-shadow:0 -6px 18px #0206170a}@media (max-width: 420px){.burbuja[_ngcontent-%COMP%]{max-width:88%}}\"]\n  });\n  return ChatRoomPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}