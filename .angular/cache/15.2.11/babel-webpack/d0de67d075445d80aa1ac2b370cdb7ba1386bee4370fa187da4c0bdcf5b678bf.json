{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/fabia/Documents/ChronosModificado/ProyectoAppRegis/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { Preferences } from '@capacitor/preferences';\nimport { ApiService } from '../servicios/api.service';\nimport { ToastController } from '@ionic/angular';\nimport { take } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"../servicios/api.service\";\nimport * as i3 from \"@ionic/angular\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\nconst _c0 = function (a1) {\n  return [\"burbuja\", a1];\n};\nfunction ChatRoomPage_div_11_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 15)(1, \"div\", 16);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"div\", 17);\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const m_r1 = ctx.$implicit;\n    i0.ɵɵproperty(\"ngClass\", i0.ɵɵpureFunction1(3, _c0, m_r1.de));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(m_r1.texto);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(m_r1.hora);\n  }\n}\nexport let ChatRoomPage = /*#__PURE__*/(() => {\n  class ChatRoomPage {\n    constructor(route, router, api, toastCtrl) {\n      this.route = route;\n      this.router = router;\n      this.api = api;\n      this.toastCtrl = toastCtrl;\n      this.conversationPartnerName = '';\n      this.profesorId = null;\n      this.alumnoId = null;\n      this.mensajes = [];\n      this.mensajeNuevo = '';\n      this.privadoRemitente = 'alumno';\n    }\n    ngOnInit() {\n      var _this = this;\n      const paramId = Number(this.route.snapshot.paramMap.get('id'));\n      // Obtener rol e ids guardados para decidir cómo interpretar el param\n      Preferences.get({\n        key: 'rol'\n      }).then( /*#__PURE__*/function () {\n        var _ref = _asyncToGenerator(function* ({\n          value\n        }) {\n          const rol = value;\n          // nombres de ejemplo (temporal)\n          const nombresProfesores = {\n            1: 'Profesor García',\n            2: 'Profesora Rodríguez',\n            3: 'Profesor Martínez',\n            4: 'Orientadora Pérez'\n          };\n          const nombresAlumnos = {\n            101: 'Alumno Juan Pérez',\n            102: 'Alumno María López',\n            103: 'Alumno Ana Gómez'\n          };\n          if (rol === 'profesor') {\n            // como profesor, el param es alumnoId\n            _this.alumnoId = paramId;\n            const {\n              value: pid\n            } = yield Preferences.get({\n              key: 'profesorId'\n            });\n            _this.profesorId = pid ? Number(pid) : null;\n            _this.conversationPartnerId = _this.alumnoId;\n            _this.conversationPartnerName = nombresAlumnos[_this.conversationPartnerId] || 'Alumno';\n            _this.privadoRemitente = 'profesor';\n          } else {\n            // como alumno, el param es profesorId\n            _this.profesorId = paramId;\n            const {\n              value: aid\n            } = yield Preferences.get({\n              key: 'alumnoId'\n            });\n            _this.alumnoId = aid ? Number(aid) : null;\n            _this.conversationPartnerId = _this.profesorId;\n            _this.conversationPartnerName = nombresProfesores[_this.conversationPartnerId] || 'Profesor';\n            _this.privadoRemitente = 'alumno';\n          }\n          // Debug: mostrar rol e ids en consola\n          console.log('ChatRoom init — rol:', rol, 'paramId:', paramId, 'profesorId:', _this.profesorId, 'alumnoId:', _this.alumnoId);\n          // Mensajes de ejemplo iniciales: si el usuario es profesor, mostrar los mensajes del profesor primero\n          if (rol === 'profesor') {\n            _this.mensajes = [{\n              de: 'profesor',\n              texto: `Hola, soy el profesor. Voy a responder tus dudas.`,\n              hora: '10:00'\n            }, {\n              de: 'alumno',\n              texto: `Hola profe, soy ${_this.conversationPartnerName} y tengo una duda.`,\n              hora: '10:01'\n            }];\n          } else {\n            _this.mensajes = [{\n              de: 'profesor',\n              texto: `Hola, soy ${_this.conversationPartnerName}. ¿En qué puedo ayudarte?`,\n              hora: '10:00'\n            }, {\n              de: 'alumno',\n              texto: 'Profe, tengo una duda sobre la guía.',\n              hora: '10:01'\n            }];\n          }\n          // Si tenemos ambos ids, cargar la conversación real desde el backend\n          if (_this.profesorId && _this.alumnoId) {\n            _this.api.getConversacion(_this.profesorId, _this.alumnoId).pipe(take(1)).subscribe({\n              next: msgs => {\n                // Esperamos que msgs venga como array de { remitente: 'profesor'|'alumno', texto, fecha }\n                _this.mensajes = msgs.map(m => ({\n                  de: m.remitente,\n                  texto: m.texto,\n                  hora: m.fecha || m.hora || ''\n                }));\n              },\n              error: function () {\n                var _ref2 = _asyncToGenerator(function* (err) {\n                  console.error('Error cargando conversacion', err);\n                  const t = yield _this.toastCtrl.create({\n                    message: 'No se pudo cargar la conversación.',\n                    duration: 2000\n                  });\n                  yield t.present();\n                });\n                return function error(_x2) {\n                  return _ref2.apply(this, arguments);\n                };\n              }()\n            });\n          }\n        });\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    }\n    enviar() {\n      var _this2 = this;\n      const texto = this.mensajeNuevo.trim();\n      if (!texto) {\n        return;\n      }\n      const ahora = new Date();\n      const hora = ahora.toLocaleTimeString([], {\n        hour: '2-digit',\n        minute: '2-digit'\n      });\n      // Preparar payload para enviar al backend\n      const payload = {\n        profesorId: this.profesorId,\n        alumnoId: this.alumnoId,\n        remitente: this.privadoRemitente,\n        texto\n      };\n      // Limpia input inmediatamente\n      this.mensajeNuevo = '';\n      // Mostrar mensaje provisional en UI para feedback (optimista)\n      this.mensajes.push({\n        de: this.privadoRemitente,\n        texto,\n        hora\n      });\n      // Enviar al backend\n      this.api.enviarMensaje(payload).pipe(take(1)).subscribe({\n        next: saved => {\n          // Si backend devuelve el mensaje guardado con fecha/id, podríamos reemplazar o actualizar.\n          // Por simplicidad, si viene texto y fecha, actualizamos la última burbuja.\n          if (saved && (saved.texto || saved.fecha)) {\n            const lastIdx = this.mensajes.length - 1;\n            this.mensajes[lastIdx] = {\n              de: saved.remitente ?? this.privadoRemitente,\n              texto: saved.texto ?? texto,\n              hora: saved.fecha ?? hora\n            };\n          }\n        },\n        error: function () {\n          var _ref3 = _asyncToGenerator(function* (err) {\n            console.error('Error enviando mensaje', err);\n            const toast = yield _this2.toastCtrl.create({\n              message: 'No se pudo enviar el mensaje.',\n              duration: 2000\n            });\n            yield toast.present();\n          });\n          return function error(_x3) {\n            return _ref3.apply(this, arguments);\n          };\n        }()\n      });\n    }\n    // Navega hacia la página correcta según el rol (profesor -> teacher-chat, alumno -> chat)\n    volver() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          value: rol\n        } = yield Preferences.get({\n          key: 'rol'\n        });\n        if (rol === 'profesor') {\n          _this3.router.navigateByUrl('/teacher-chat');\n        } else {\n          _this3.router.navigateByUrl('/chat');\n        }\n      })();\n    }\n  }\n  ChatRoomPage.ɵfac = function ChatRoomPage_Factory(t) {\n    return new (t || ChatRoomPage)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i1.Router), i0.ɵɵdirectiveInject(i2.ApiService), i0.ɵɵdirectiveInject(i3.ToastController));\n  };\n  ChatRoomPage.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: ChatRoomPage,\n    selectors: [[\"app-chat-room\"]],\n    decls: 18,\n    vars: 3,\n    consts: [[1, \"chat-header\", \"ion-no-border\"], [1, \"header-toolbar\"], [\"slot\", \"start\"], [\"fill\", \"clear\", \"aria-label\", \"Volver\", 3, \"click\"], [\"slot\", \"icon-only\", \"name\", \"chevron-back-outline\"], [1, \"brand\"], [\"name\", \"person-circle-outline\"], [1, \"chat-room-content\"], [1, \"mensajes\"], [3, \"ngClass\", 4, \"ngFor\", \"ngForOf\"], [1, \"chat-input-footer\"], [\"lines\", \"none\"], [\"placeholder\", \"Escribe un mensaje\", 3, \"ngModel\", \"ngModelChange\", \"keyup.enter\"], [\"fill\", \"clear\", 3, \"click\"], [\"name\", \"send-outline\"], [3, \"ngClass\"], [1, \"texto\"], [1, \"hora\"]],\n    template: function ChatRoomPage_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"ion-header\", 0)(1, \"ion-toolbar\", 1)(2, \"ion-buttons\", 2)(3, \"ion-button\", 3);\n        i0.ɵɵlistener(\"click\", function ChatRoomPage_Template_ion_button_click_3_listener() {\n          return ctx.volver();\n        });\n        i0.ɵɵelement(4, \"ion-icon\", 4);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(5, \"ion-title\", 5);\n        i0.ɵɵelement(6, \"ion-icon\", 6);\n        i0.ɵɵelementStart(7, \"span\");\n        i0.ɵɵtext(8);\n        i0.ɵɵelementEnd()()()();\n        i0.ɵɵelementStart(9, \"ion-content\", 7)(10, \"div\", 8);\n        i0.ɵɵtemplate(11, ChatRoomPage_div_11_Template, 5, 5, \"div\", 9);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(12, \"ion-footer\", 10)(13, \"ion-toolbar\")(14, \"ion-item\", 11)(15, \"ion-input\", 12);\n        i0.ɵɵlistener(\"ngModelChange\", function ChatRoomPage_Template_ion_input_ngModelChange_15_listener($event) {\n          return ctx.mensajeNuevo = $event;\n        })(\"keyup.enter\", function ChatRoomPage_Template_ion_input_keyup_enter_15_listener() {\n          return ctx.enviar();\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(16, \"ion-button\", 13);\n        i0.ɵɵlistener(\"click\", function ChatRoomPage_Template_ion_button_click_16_listener() {\n          return ctx.enviar();\n        });\n        i0.ɵɵelement(17, \"ion-icon\", 14);\n        i0.ɵɵelementEnd()()()();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(8);\n        i0.ɵɵtextInterpolate(ctx.conversationPartnerName);\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"ngForOf\", ctx.mensajes);\n        i0.ɵɵadvance(4);\n        i0.ɵɵproperty(\"ngModel\", ctx.mensajeNuevo);\n      }\n    },\n    dependencies: [i4.NgClass, i4.NgForOf, i5.NgControlStatus, i5.NgModel, i3.IonButton, i3.IonButtons, i3.IonContent, i3.IonFooter, i3.IonHeader, i3.IonIcon, i3.IonInput, i3.IonItem, i3.IonTitle, i3.IonToolbar, i3.TextValueAccessor],\n    styles: [\".chat-room-content[_ngcontent-%COMP%]{--background: #f6f7fb}.mensajes[_ngcontent-%COMP%]{padding:12px;display:flex;flex-direction:column;gap:8px}.burbuja[_ngcontent-%COMP%]{max-width:80%;padding:8px 10px;border-radius:12px;font-size:14px}.burbuja.profesor[_ngcontent-%COMP%]{align-self:flex-start;background:#e5e7eb}.burbuja.alumno[_ngcontent-%COMP%]{align-self:flex-end;background:#3b82f6;color:#fff}.burbuja[_ngcontent-%COMP%]   .hora[_ngcontent-%COMP%]{font-size:11px;opacity:.7;margin-top:2px;text-align:right}.chat-input-footer[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]{--background: #fff}\"]\n  });\n  return ChatRoomPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}