{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/fabia/Documents/ChronosModificado/ProyectoAppRegis/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { Router } from '@angular/router';\nimport { Preferences } from '@capacitor/preferences';\nimport { take } from 'rxjs/operators';\nimport { ApiService } from '../servicios/api.service';\nimport { ToastController } from '@ionic/angular';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"../servicios/api.service\";\nimport * as i3 from \"@ionic/angular\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@angular/forms\";\nfunction ChatPage_ion_item_17_ion_badge_11_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ion-badge\", 33);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const c_r1 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate(c_r1.unread);\n  }\n}\nfunction ChatPage_ion_item_17_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r5 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-item\", 25);\n    i0.ɵɵlistener(\"click\", function ChatPage_ion_item_17_Template_ion_item_click_0_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r5);\n      const c_r1 = restoredCtx.$implicit;\n      const ctx_r4 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r4.openChat(c_r1));\n    });\n    i0.ɵɵelementStart(1, \"ion-avatar\", 26);\n    i0.ɵɵelement(2, \"img\", 27);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"ion-label\")(4, \"div\", 28)(5, \"h3\", 29);\n    i0.ɵɵtext(6);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"div\", 30);\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(9, \"p\", 31);\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵtemplate(11, ChatPage_ion_item_17_ion_badge_11_Template, 2, 1, \"ion-badge\", 32);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const c_r1 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"src\", c_r1.avatar || \"assets/images/avatar-default.png\", i0.ɵɵsanitizeUrl);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(c_r1.nombre);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(c_r1.hora);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(c_r1.mensaje);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", c_r1.unread);\n  }\n}\nexport let ChatPage = /*#__PURE__*/(() => {\n  class ChatPage {\n    constructor(router, api, toastCtrl) {\n      this.router = router;\n      this.api = api;\n      this.toastCtrl = toastCtrl;\n      this.query = '';\n      this.chats = [];\n      this.isProfesor = false;\n      this.initChats();\n    }\n    initChats() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        const {\n          value: rol\n        } = yield Preferences.get({\n          key: 'rol'\n        });\n        _this.isProfesor = rol === 'profesor';\n        if (_this.isProfesor) {\n          // Lista de alumnos para el profesor (ejemplo estático, reemplazar por API)\n          _this.chats = [{\n            id: 101,\n            nombre: 'Alumno Juan Pérez',\n            mensaje: 'Profe, ¿puede revisar mi nota?',\n            hora: '10:30 AM',\n            unread: 1\n          }, {\n            id: 102,\n            nombre: 'Alumno María López',\n            mensaje: '¿Hay guías disponibles?',\n            hora: 'Ayer'\n          }];\n        } else {\n          // Intentar cargar profesores reales desde el backend\n          _this.api.getProfesores().pipe(take(1)).subscribe({\n            next: list => {\n              console.log('getProfesores response:', list);\n              const mapped = (list || []).map(p => {\n                const nombre = (p.nombreCompleto ?? p.nombre ?? p.nom_prof ?? (p.nombres ? `${p.nombres} ${p.apellidos}` : undefined) ?? (p.correoElectronico ? p.correoElectronico.split('@')[0] : undefined) ?? '').toString().trim();\n                return {\n                  id: p.id,\n                  nombre: nombre || `Profesor ${p.id}`,\n                  mensaje: p.ultimoMensaje ?? p.ultimo_mensaje ?? '',\n                  hora: p.ultimaHora ?? p.ultima_hora ?? '',\n                  avatar: p.avatarUrl ?? p.avatar ?? ''\n                };\n              });\n              // Asignar la lista tal cual; si viene vacía, mostraremos un estado vacío en la UI\n              _this.chats = mapped;\n            },\n            error: function () {\n              var _ref = _asyncToGenerator(function* (err) {\n                console.warn('No se pudo cargar profesores', err);\n                const t = yield _this.toastCtrl.create({\n                  message: 'No se pudo cargar profesores desde el servidor.',\n                  duration: 2500\n                });\n                yield t.present();\n                // mantener lista vacía — UI mostrará estado vacío\n              });\n              return function error(_x) {\n                return _ref.apply(this, arguments);\n              };\n            }()\n          });\n        }\n      })();\n    }\n    // Abre la conversación correcta según el rol y el id del item\n    openChat(c) {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        const {\n          value: rol\n        } = yield Preferences.get({\n          key: 'rol'\n        });\n        const isProfesor = rol === 'profesor';\n        // Si es profesor, asumimos que `c.id` es alumnoId; si es alumno, `c.id` es profesorId.\n        const idToOpen = c.id;\n        yield _this2.router.navigate(['/chat-room', idToOpen]);\n      })();\n    }\n    get filtered() {\n      const q = this.query.toLowerCase();\n      return this.chats.filter(c => c.nombre.toLowerCase().includes(q) || c.mensaje.toLowerCase().includes(q));\n    }\n  }\n  ChatPage.ɵfac = function ChatPage_Factory(t) {\n    return new (t || ChatPage)(i0.ɵɵdirectiveInject(i1.Router), i0.ɵɵdirectiveInject(i2.ApiService), i0.ɵɵdirectiveInject(i3.ToastController));\n  };\n  ChatPage.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: ChatPage,\n    selectors: [[\"app-chat\"]],\n    decls: 41,\n    vars: 2,\n    consts: [[1, \"chat-header\", \"ion-no-border\"], [1, \"header-toolbar\"], [1, \"brand\"], [\"name\", \"chatbubbles-outline\"], [1, \"top-search\"], [\"placeholder\", \"Buscar docentes o mensajes\", \"showCancelButton\", \"never\", 3, \"ngModel\", \"ngModelChange\"], [1, \"chat-content\"], [\"value\", \"conversaciones\", 1, \"chat-segment\"], [\"value\", \"conversaciones\"], [\"value\", \"docentes\"], [\"lines\", \"none\", 1, \"chat-list\"], [\"button\", \"\", \"class\", \"chat-item\", 3, \"click\", 4, \"ngFor\", \"ngForOf\"], [\"vertical\", \"bottom\", \"horizontal\", \"end\", \"slot\", \"fixed\"], [\"color\", \"primary\", \"aria-label\", \"Nuevo mensaje\"], [\"name\", \"create-outline\"], [1, \"tabs\"], [\"slot\", \"bottom\"], [\"routerLink\", \"/home\"], [\"name\", \"home-outline\"], [\"routerLink\", \"/notas\"], [\"name\", \"book-outline\"], [\"routerLink\", \"/asistencia\"], [\"name\", \"calendar-outline\"], [\"routerLink\", \"/chat\", \"selected\", \"true\"], [\"name\", \"chatbubble-ellipses-outline\"], [\"button\", \"\", 1, \"chat-item\", 3, \"click\"], [\"slot\", \"start\"], [\"alt\", \"avatar\", 3, \"src\"], [1, \"row\"], [1, \"name\"], [1, \"time\"], [1, \"preview\"], [\"color\", \"primary\", 4, \"ngIf\"], [\"color\", \"primary\"]],\n    template: function ChatPage_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵelementStart(0, \"ion-header\", 0)(1, \"ion-toolbar\", 1)(2, \"ion-title\", 2);\n        i0.ɵɵelement(3, \"ion-icon\", 3);\n        i0.ɵɵelementStart(4, \"span\");\n        i0.ɵɵtext(5, \"Mensajes\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(6, \"div\", 4)(7, \"ion-searchbar\", 5);\n        i0.ɵɵlistener(\"ngModelChange\", function ChatPage_Template_ion_searchbar_ngModelChange_7_listener($event) {\n          return ctx.query = $event;\n        });\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(8, \"ion-content\", 6)(9, \"ion-segment\", 7)(10, \"ion-segment-button\", 8)(11, \"ion-label\");\n        i0.ɵɵtext(12, \"Conversaciones\");\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(13, \"ion-segment-button\", 9)(14, \"ion-label\");\n        i0.ɵɵtext(15, \"Docentes\");\n        i0.ɵɵelementEnd()()();\n        i0.ɵɵelementStart(16, \"ion-list\", 10);\n        i0.ɵɵtemplate(17, ChatPage_ion_item_17_Template, 12, 5, \"ion-item\", 11);\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(18, \"ion-fab\", 12)(19, \"ion-fab-button\", 13);\n        i0.ɵɵelement(20, \"ion-icon\", 14);\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(21, \"ion-footer\", 15)(22, \"ion-toolbar\")(23, \"ion-tabs\")(24, \"ion-tab-bar\", 16)(25, \"ion-tab-button\", 17);\n        i0.ɵɵelement(26, \"ion-icon\", 18);\n        i0.ɵɵelementStart(27, \"ion-label\");\n        i0.ɵɵtext(28, \"Inicio\");\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(29, \"ion-tab-button\", 19);\n        i0.ɵɵelement(30, \"ion-icon\", 20);\n        i0.ɵɵelementStart(31, \"ion-label\");\n        i0.ɵɵtext(32, \"Notas\");\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(33, \"ion-tab-button\", 21);\n        i0.ɵɵelement(34, \"ion-icon\", 22);\n        i0.ɵɵelementStart(35, \"ion-label\");\n        i0.ɵɵtext(36, \"Asistencia\");\n        i0.ɵɵelementEnd()();\n        i0.ɵɵelementStart(37, \"ion-tab-button\", 23);\n        i0.ɵɵelement(38, \"ion-icon\", 24);\n        i0.ɵɵelementStart(39, \"ion-label\");\n        i0.ɵɵtext(40, \"Chat\");\n        i0.ɵɵelementEnd()()()()()()();\n      }\n      if (rf & 2) {\n        i0.ɵɵadvance(7);\n        i0.ɵɵproperty(\"ngModel\", ctx.query);\n        i0.ɵɵadvance(10);\n        i0.ɵɵproperty(\"ngForOf\", ctx.filtered);\n      }\n    },\n    dependencies: [i4.NgForOf, i4.NgIf, i5.NgControlStatus, i5.NgModel, i3.IonAvatar, i3.IonBadge, i3.IonContent, i3.IonFab, i3.IonFabButton, i3.IonFooter, i3.IonHeader, i3.IonIcon, i3.IonItem, i3.IonLabel, i3.IonList, i3.IonSearchbar, i3.IonSegment, i3.IonSegmentButton, i3.IonTabBar, i3.IonTabButton, i3.IonTitle, i3.IonToolbar, i3.SelectValueAccessor, i3.TextValueAccessor, i3.IonTabs, i3.RouterLinkDelegate, i1.RouterLink],\n    styles: [\".chat-header[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f43f5e,#3b82f6);color:#fff}.header-toolbar[_ngcontent-%COMP%]{--background: transparent;color:#fff}.brand[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-weight:700}.top-search[_ngcontent-%COMP%]{padding:8px 12px 12px}.chat-content[_ngcontent-%COMP%]{--background:#f6f7fb}.chat-list[_ngcontent-%COMP%]   .chat-item[_ngcontent-%COMP%]{--background:#fff;--min-height:68px;--padding-start:12px;--inner-padding-end:12px;border-radius:14px;margin:6px 12px;box-shadow:0 8px 28px #1018280f}.chat-list[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between}.chat-list[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{font-weight:700;color:#0f172a}.chat-list[_ngcontent-%COMP%]   .time[_ngcontent-%COMP%]{color:#98a2b3;font-size:12px}.chat-list[_ngcontent-%COMP%]   .preview[_ngcontent-%COMP%]{color:#6b7280;font-size:13px;margin-top:4px}ion-footer.tabs[_ngcontent-%COMP%]{position:sticky;bottom:0}\"]\n  });\n  return ChatPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}